---
- name: Setup Service Account Ansible
  hosts: all
  remote_user: root
  gather_facts: yes
  vars:
    target_user: ansible
    pub_key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"

  tasks:
    - name: Crea account di servizio ansible
      user:
        name: "{{ target_user }}"
        comment: "Ansible Automation Service Account"
        system: yes
        shell: /bin/bash
        create_home: yes
        home: /home/ansible
        groups: "{{ 'wheel' if ansible_os_family == 'RedHat' else 'sudo' }}"
        append: yes
        state: present

    - name: Deploy chiave SSH per il service account
      authorized_key:
        user: "{{ target_user }}"
        key: "{{ pub_key }}"
        state: present

    - name: Configura Sudoers senza password
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^ansible ALL='
        line: '{{ target_user }} ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
